<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HR-JMT</title>

    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

    <style>
        body {
            font-family: 'Sarabun', sans-serif;
            background-image: url('https://img2.pic.in.th/pic/Cover808900978ea91797.jpg');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 1rem;
        }
        .register-card {
            background-color: rgba(255, 255, 255, 0.98);
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            border: none;
            display: flex;
            flex-direction: row;
            max-width: 900px;
            width: 100%;
        }
        .register-image-side {
            background: url('https://img2.pic.in.th/pic/Gemini_Generated_Image_rqnmqyrqnmqyrqnm.png') center/cover;
            width: 45%;
        }
        .register-form-side {
            width: 55%;
            padding: 3rem;
        }
        .card-title {
            font-weight: 700;
            color: #333;
            margin-bottom: 0.5rem;
            font-size: 1.75rem;
        }
        .card-subtitle {
            color: #6c757d;
            margin-bottom: 2rem;
            font-size: 1.1rem;
        }
        .form-label {
            font-weight: 500;
            color: #495057;
        }
        .input-group-text {
            background-color: transparent;
            border-right: none;
            color: #343a40;
            font-size: 1.1rem;
        }
        .form-control {
            border-left: none;
            border-radius: 0 0.25rem 0.25rem 0;
            padding-left: 0;
            transition: all 0.3s ease;
            font-size: 1rem;
        }
        .form-control:read-only {
            background-color: #e9ecef;
            cursor: not-allowed;
        }
        .form-control:focus {
            box-shadow: none;
            border-color: #555;
        }
        .btn-success {
            background: linear-gradient(45deg, #1E8449, #28B463);
            border: none;
            border-radius: 50px;
            padding: 12px 30px;
            font-weight: 700;
            font-size: 1rem;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(30, 132, 73, 0.3);
        }
        .btn-success:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(30, 132, 73, 0.4);
        }
        .btn-success:disabled {
            background: #a5d6a7;
            cursor: not-allowed;
        }
        .consent-section {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 12px;
            padding: 1.25rem;
            margin-top: 1.5rem;
            margin-bottom: 1.5rem;
            transition: box-shadow 0.2s ease-in-out;
        }
        .consent-section:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }
        .consent-title {
            font-weight: 700;
            color: #343a40;
            font-size: 1rem;
            margin-bottom: 0.75rem;
        }
        .custom-switch .custom-control-label {
            color: #495057;
            font-size: 0.9rem;
            cursor: pointer;
        }
        .custom-control-input:checked~.custom-control-label::before {
            border-color: #1E8449;
            background-color: #28B463;
        }
        @media (max-width: 768px) {
            .register-image-side { display: none; }
            .register-form-side { width: 100%; padding: 2rem; }
            .register-card { flex-direction: column; }
        }
    </style>
</head>
<body>

<div class="register-card">
    <div class="register-image-side"></div>
    <div class="register-form-side">
        <div class="text-center mb-4">
            <img src="https://img5.pic.in.th/file/secure-sv1/-1920-x-300-px.png" alt="Company Logo" style="max-width: 250px; margin-bottom: 1.5rem;">
            <h3 class="card-title">ยืนยันตัวตนพนักงาน</h3>
            <p class="card-subtitle">กรุณากรอกข้อมูลด้วยไลน์ตัวเอง!</p>
        </div>

        <form method="post" autocomplete="off" name="hello-sheet" id="registerForm">
            <div class="mb-3">
                <label for="IdEmployee" class="form-label">Employee ID</label>
                <div class="input-group">
                    <div class="input-group-prepend"><span class="input-group-text"><i class="fa-solid fa-id-card-clip"></i></span></div>
                    <input type="text" class="form-control" id="IdEmployee" placeholder="รหัสพนักงาน" name="รหัสพนักงาน" required>
                </div>
            </div>
             <div class="mb-3">
                <label for="fullName" class="form-label">Full Name</label>
                <div class="input-group">
                    <div class="input-group-prepend"><span class="input-group-text"><i class="fa-solid fa-user"></i></span></div>
                    <input type="text" class="form-control" id="fullName" placeholder="ชื่อ-สกุล (จะแสดงอัตโนมัติเมื่อกรอกรหัสพนักงาน)" name="ชื่อ-สกุล" required readonly>
                </div>
            </div>
            <div class="mb-3">
                <label for="phone" class="form-label">Phone Number</label>
                <div class="input-group">
                    <div class="input-group-prepend"><span class="input-group-text"><i class="fa-solid fa-phone"></i></span></div>
                    <input type="tel" class="form-control" id="phone" placeholder="เบอร์โทรศัพท์" name="เบอร์โทร" required>
                </div>
            </div>
            
            <input type="hidden" name="userID" id="userID">
            
            <div class="mb-3">
                <label class="form-label">สแกนใบหน้า (ถ่ายรูป)</label>
                <div id="camera-container" class="text-center bg-light p-2" style="border-radius: 10px; position: relative; overflow: hidden;">
                    <video id="video" width="100%" height="auto" autoplay playsinline style="display: none; transform: scaleX(-1);"></video>
                    <canvas id="canvas" style="display:none;"></canvas>
                    <img id="face-overlay" 
                         src="https://img2.pic.in.th/pic/-44e1002fd11c7044b.png" 
                         alt="ตัวอย่างกรอบใบหน้า" 
                         style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: contain; display: none; pointer-events: none; opacity: 0.7;">
                    <img id="photo-preview" src="" alt="รูปที่ถ่าย" style="max-width: 100%; border-radius: 10px; display: none; margin: auto;" />
                    <div id="camera-placeholder">
                          <i class="fas fa-camera fa-3x text-muted"></i>
                          <p class="text-muted mt-2">กรุณากด 'เปิดกล้อง' เพื่อถ่ายรูป</p>
                    </div>
                </div>
                <div class="text-center mt-2">
                    <button type="button" id="start-camera-btn" class="btn btn-info btn-sm"> <i class="fas fa-camera"></i> เปิดกล้อง</button>
                    <button type="button" id="capture-btn" class="btn btn-primary btn-sm" style="display: none;"> <i class="fas fa-circle-check"></i> ถ่ายรูป</button>
                    <button type="button" id="retake-btn" class="btn btn-warning btn-sm" style="display: none;"> <i class="fas fa-redo"></i> ถ่ายใหม่</button>
                </div>
                <input type="hidden" name="รูปถ่ายใบหน้า" id="facePhotoData" required>
            </div>

            <div class="consent-section">
                <h5 class="consent-title"><i class="fa-solid fa-shield-halved"></i> ข้อกำหนดและความยินยอม</h5>
                <div class="custom-control custom-switch">
                    <input type="checkbox" class="custom-control-input" id="consentCheck" name="consent" value="ยินยอม" required>
                    <label class="custom-control-label" for="consentCheck">
                        ข้าพเจ้ายินยอมให้บริษัทเก็บ รวบรวม ใช้ข้อมูลได้แก่ภาพใบหน้า ชื่อนามสกุล และอื่นๆที่ระบุในฟอร์ม เพื่อใช้ในการยืนยันตัวตนพนักงานและแจ้งข่าวสารต่างๆ รวมไปถึงสิทธิประโยชน์อื่นๆที่พนักงานได้รับผ่านช่องทางไลน์นี้
                    </label>
                </div>
            </div>

            <div class="text-center mt-4">
                <button type="submit" class="btn btn-success fw-bold w-100" id="registerBtn" disabled>บันทึกข้อมูล</button>
            </div>
        </form>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    // --- LIFF Initialization ---
    async function main() {
        await liff.init({ liffId: "1654380017-Jj6lnbYq" }); // ◀️ **สำคัญ:** ใส่ LIFF ID ของคุณที่นี่
        if (!liff.isLoggedIn()) {
            liff.login();
        } else {
            const profile = await liff.getProfile();
            document.getElementById('userID').value = profile.userId;
        }
    }
    main();

    // --- Form & Sheet Configuration ---
    const scriptURL = 'https://script.google.com/macros/s/AKfycbwL-Dgoy6so2-iMFSppikEhNuU-pLaVoYr5FbgE5hVUXntW1p0wsNtdQ_3AwfFJo6G8/exec'; // ◀️ **สำคัญ:** ใช้ URL ที่ได้จากการ Deploy ของคุณ
    const form = document.forms['hello-sheet'];
    const registerBtn = document.getElementById('registerBtn');
    const consentCheckbox = document.getElementById('consentCheck');
    const employeeIdInput = document.getElementById('IdEmployee');
    const fullNameInput = document.getElementById('fullName');

    // --- ✨ Camera Logic (แก้ไขให้ใช้เฉพาะกล้องหน้า) ---
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const facePhotoDataInput = document.getElementById('facePhotoData');
    const photoPreview = document.getElementById('photo-preview');
    const cameraPlaceholder = document.getElementById('camera-placeholder');
    const faceOverlay = document.getElementById('face-overlay');

    const startCameraBtn = document.getElementById('start-camera-btn');
    const captureBtn = document.getElementById('capture-btn');
    // const switchCameraBtn = document.getElementById('switch-camera-btn'); // ◀️ ลบตัวแปรนี้ออก
    const retakeBtn = document.getElementById('retake-btn');

    let currentStream;
    // let facingMode = 'user'; // ◀️ ลบตัวแปรนี้ออก ไม่จำเป็นต้องสลับกล้องแล้ว

    async function startCamera() {
        if (currentStream) {
            currentStream.getTracks().forEach(track => track.stop());
        }
        try {
            const constraints = {
                video: {
                    // ◀️ **แก้ไข:** บังคับให้ใช้กล้องหน้าเสมอ
                    facingMode: 'user', 
                    width: { ideal: 480 },
                    height: { ideal: 640 }
                }
            };
            currentStream = await navigator.mediaDevices.getUserMedia(constraints);
            video.srcObject = currentStream;
            video.style.display = 'block';
            faceOverlay.style.display = 'block';
            cameraPlaceholder.style.display = 'none';
            startCameraBtn.style.display = 'none';
            captureBtn.style.display = 'inline-block';
            // switchCameraBtn.style.display = 'inline-block'; // ◀️ ลบบรรทัดนี้ออก
            retakeBtn.style.display = 'none';
            photoPreview.style.display = 'none';
        } catch (err) {
            console.error("Error accessing camera: ", err);
            Swal.fire('เกิดข้อผิดพลาด', 'ไม่สามารถเข้าถึงกล้องได้ กรุณาตรวจสอบการอนุญาตให้ใช้กล้อง', 'error');
        }
    }

    startCameraBtn.addEventListener('click', startCamera);

    // ◀️ ลบ Event Listener ของปุ่มสลับกล้องออกทั้งหมด
    // switchCameraBtn.addEventListener('click', () => { ... });

    captureBtn.addEventListener('click', () => {
        const context = canvas.getContext('2d');
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        
        // Flip the canvas context horizontally to match the preview
        context.translate(canvas.width, 0);
        context.scale(-1, 1);
        context.drawImage(video, 0, 0, canvas.width, canvas.height);
        
        // Convert to Base64 and set value
        const dataUrl = canvas.toDataURL('image/jpeg', 0.9);
        facePhotoDataInput.value = dataUrl;
        photoPreview.src = dataUrl;

        // Update UI
        video.style.display = 'none';
        faceOverlay.style.display = 'none';
        photoPreview.style.display = 'block';
        captureBtn.style.display = 'none';
        // switchCameraBtn.style.display = 'none'; // ◀️ ลบบรรทัดนี้ออก
        retakeBtn.style.display = 'inline-block';

        // Stop camera stream
        currentStream.getTracks().forEach(track => track.stop());
    });
    
    retakeBtn.addEventListener('click', startCamera);

    // --- Employee ID Verification ---
    employeeIdInput.addEventListener('blur', function() {
        const employeeId = this.value.trim();
        if (employeeId === '') {
            fullNameInput.value = '';
            fullNameInput.readOnly = true;
            return;
        }

        const formData = new FormData();
        formData.append('action', 'getEmployeeName');
        formData.append('employeeId', employeeId);

        Swal.fire({
            title: 'กำลังตรวจสอบรหัสพนักงาน...',
            allowOutsideClick: false,
            didOpen: () => { Swal.showLoading(); }
        });

        fetch(scriptURL, { method: 'POST', body: formData })
            .then(response => response.json())
            .then(data => {
                Swal.close();
                if (data.result === 'success') {
                    fullNameInput.value = data.name;
                    fullNameInput.readOnly = true;
                } else if (data.error === 'duplicate_employee_id') {
                    Swal.fire('ลงทะเบียนแล้ว', 'รหัสพนักงานนี้ได้ลงทะเบียนในระบบแล้ว', 'warning');
                    fullNameInput.value = '';
                    fullNameInput.readOnly = true;
                } else {
                    Swal.fire('ไม่พบข้อมูล', 'ไม่พบรหัสพนักงานนี้ในระบบ กรุณาตรวจสอบอีกครั้ง', 'error');
                    fullNameInput.value = '';
                    fullNameInput.readOnly = true;
                }
            })
            .catch(error => {
                Swal.fire('เกิดข้อผิดพลาด', 'ไม่สามารถเชื่อมต่อกับเซิร์ฟเวอร์ได้', 'error');
                console.error('Error fetching employee name:', error);
                fullNameInput.value = '';
                fullNameInput.readOnly = true;
            });
    });

    // --- Consent & Submit Button ---
    consentCheckbox.addEventListener('change', function() {
        registerBtn.disabled = !this.checked;
    });

    // --- Form Submission ---
    form.addEventListener('submit', e => {
        e.preventDefault();

        if (facePhotoDataInput.value === '') {
             Swal.fire('ยังไม่ได้ถ่ายรูป', 'กรุณาถ่ายรูปใบหน้าเพื่อยืนยันตัวตน', 'warning');
             return;
        }
        
        if (!form.checkValidity()) {
            Swal.fire('ข้อมูลไม่ครบถ้วน', 'กรุณากรอกข้อมูลและทำเครื่องหมายยินยอมให้ครบถ้วนก่อน', 'warning');
            return;
        }
        
        Swal.fire({
            title: 'กำลังตรวจสอบและบันทึกข้อมูล...',
            text: 'กรุณารอสักครู่',
            allowOutsideClick: false,
            didOpen: () => { Swal.showLoading(); }
        });
        
        const formData = new FormData(form);
        formData.append('action', 'register'); 

        fetch(scriptURL, { method: 'POST', body: formData })
            .then(response => response.json())
            .then(data => {
                if (data.result === 'success') {
                    Swal.fire({
                        position: 'center', icon: 'success', title: 'บันทึกข้อมูลสำเร็จ!',
                        text: 'ข้อมูลของคุณถูกบันทึกในระบบเรียบร้อยแล้ว', showConfirmButton: false, timer: 2500
                    }).then(() => {
                        if(liff.isInClient()) {
                            liff.closeWindow();
                        } else {
                            window.location.reload();
                        }
                    });
                } else if (data.error === 'duplicate_user') {
                    Swal.fire('ลงทะเบียนแล้ว', 'คุณได้ยืนยันตัวตนไว้ในระบบแล้ว หากต้องการแก้ไขข้อมูลกรุณาติดต่อฝ่ายบุคคล', 'warning');
                } else if (data.error === 'duplicate_employee_id') {
                    Swal.fire('ลงทะเบียนแล้ว', 'รหัสพนักงานนี้ได้ถูกลงทะเบียนแล้ว กรุณาติดต่อฝ่ายบุคคล', 'error');
                } else if (data.error === 'invalid_employee_id') {
                    Swal.fire('รหัสพนักงานไม่ถูกต้อง', 'ไม่พบรหัสพนักงานของคุณในระบบ กรุณาตรวจสอบอีกครั้ง', 'error');
                } else if (data.error === 'consent_required') {
                    Swal.fire('ไม่ได้รับความยินยอม', 'เกิดข้อผิดพลาด: กรุณาทำเครื่องหมายยินยอมก่อนบันทึก', 'error');
                } else {
                    throw new Error(data.error || 'Something went wrong');
                }
            })
            .catch(error => {
                console.error('Error!', error.message);
                Swal.fire('เกิดข้อผิดพลาด!', `ไม่สามารถบันทึกข้อมูลได้: ${error.message}`, 'error');
            });
    });
</script>

</body>
</html>




