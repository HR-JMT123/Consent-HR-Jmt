<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HR-JMT</title>

    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css" integrity="sha512-xh6O/CkQoPOWDdYTDqeRdPCVd1SpvCA9XXcUnZS2FmJNp1coAFzvtCN9BmamE+4aHK8yyUHUSCcJHgXloTyT2A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

    <style>
        /* --- CSS ที่ปรับปรุงใหม่ (โทนสีแดง) --- */
        body {
            font-family: 'Kanit', sans-serif;
            /* เปลี่ยน Background Image เป็นโทนสีแดง */
            background-image: url('https://img2.pic.in.th/pic/blue-gradient-abstract-background-empty-room-with-space-your-text-picture.jpg');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 1rem;
        }

        .register-card {
            background-color: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            border: none;
            display: flex;
            flex-direction: row;
            max-width: 900px;
            width: 100%;
        }

        .register-image-side {
            /* เปลี่ยนรูปด้านข้างให้ดูเป็นทางการขึ้น */
            background: url('https://img2.pic.in.th/pic/Gemini_Generated_Image_rqnmqyrqnmqyrqnm.png') center/cover;
            width: 45%;
        }

        .register-form-side {
            width: 55%;
            padding: 3rem;
        }

        .card-title {
            font-weight: 700;
            color: #333;
            margin-bottom: 0.5rem;
        }

        .card-subtitle {
            color: #6c757d;
            margin-bottom: 2rem;
        }

        .form-label {
            font-weight: 500;
            color: #555;
        }

        .input-group-text {
            background-color: transparent;
            border-right: none;
            /* เปลี่ยนสีไอคอนเป็นสีแดง */
            color: #dc3545;
        }

        .form-control {
            border-left: none;
            border-radius: 0 0.25rem 0.25rem 0;
            padding-left: 0;
            transition: all 0.3s ease;
        }

        .form-control:focus {
            box-shadow: none;
            /* เปลี่ยนสี Border ตอน Focus เป็นสีแดง */
            border-color: #dc3545;
        }

        .btn-primary {
            /* เปลี่ยน Gradient ของปุ่มเป็นโทนสีแดง */
            background: linear-gradient(45deg, #dc3545, #c82333);
            border: none;
            border-radius: 50px;
            padding: 12px 30px;
            font-weight: 700;
            transition: all 0.3s ease;
            /* เปลี่ยนสีเงาของปุ่มเป็นโทนสีแดง */
            box-shadow: 0 4px 15px rgba(220, 53, 69, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            /* เปลี่ยนสีเงาของปุ่มตอน Hover */
            box-shadow: 0 6px 20px rgba(220, 53, 69, 0.4);
        }

        @media (max-width: 768px) {
            .register-image-side { display: none; }
            .register-form-side { width: 100%; padding: 2rem; }
            .register-card { flex-direction: column; }
        }
    </style>
</head>
<body>

<div class="register-card">
    <div class="register-image-side"></div>
    <div class="register-form-side">
        <div class="text-center mb-4">
            <h3 class="card-title">ยืนยันตัวตนพนักงาน</h3>
            <p class="card-subtitle">กรุณากรอกข้อมูลให้ถูกต้อง!</p>
        </div>

        <form method="post" autocomplete="off" name="hello-sheet" id="registerForm">
            <div class="mb-3">
                <label for="fullName" class="form-label">ชื่อ-สกุล</label>
                <div class="input-group">
                    <div class="input-group-prepend"><span class="input-group-text"><i class="fas fa-user"></i></span></div>
                    <input type="text" class="form-control" id="fullName" placeholder="Full Name" name="ชื่อ-สกุล" required>
                </div>
            </div>
            <div class="mb-3">
                <label for="IdEmployee" class="form-label">รหัสพนักงาน</label>
                <div class="input-group">
                    <div class="input-group-prepend"><span class="input-group-text"><i class="fas fa-id-card"></i></span></div>
                    <input type="text" class="form-control" id="IdEmployee" placeholder="Employee ID" name="รหัสพนักงาน" required>
                </div>
            </div>
            <div class="mb-3">
                <label for="phone" class="form-label">เบอร์โทรศัพท์</label>
                <div class="input-group">
                    <div class="input-group-prepend"><span class="input-group-text"><i class="fas fa-phone"></i></span></div>
                    <input type="tel" class="form-control" id="phone" placeholder="Phone Number" name="เบอร์โทร" required>
                </div>
            </div>
            <div class="mb-3">
                <label for="email" class="form-label">อีเมล</label>
                <div class="input-group">
                    <div class="input-group-prepend"><span class="input-group-text"><i class="fas fa-envelope"></i></span></div>
                    <input type="email" name="อีเมล" class="form-control" id="email" placeholder="Email Address" required>
                </div>
            </div>
            
            <div class="mb-3" id="otp-group" style="display: none;">
                <label for="otp" class="form-label">รหัส OTP (ตรวจสอบในอีเมลของคุณ)</label>
                <div class="input-group">
                    <div class="input-group-prepend"><span class="input-group-text"><i class="fas fa-key"></i></span></div>
                    <input type="text" class="form-control" id="otp" name="otp" placeholder="กรอกรหัส 6 หลัก">
                </div>
            </div>
            
            <input type="hidden" name="userID" id="userID">

            <div class="text-center mt-4">
                <button type="button" class="btn btn-primary fw-bold w-50" id="sendOtpBtn">ขอรหัส OTP</button>
                <button type="submit" class="btn btn-success fw-bold w-50" id="registerBtn" style="display: none;">ลงทะเบียน</button>
            </div>
        </form>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    // --- ส่วนของ Javascript ไม่มีการเปลี่ยนแปลง ---
    async function main() {
        await liff.init({ liffId: "1654380017-Jj6lnbYq" }); // ◀️ **สำคัญ:** ใส่ LIFF ID ของคุณที่นี่
        if (!liff.isLoggedIn()) {
            liff.login();
        } else {
            const profile = await liff.getProfile();
            document.getElementById('userID').value = profile.userId;
        }
    }
    main();

    const scriptURL = 'https://script.google.com/macros/s/AKfycby4A-9Ft4Oy_g1skWuxY3gixmvcXqx59KVkCyxhqvsLiqBJHc_b-j2MyHlCdZ5-2cdP/exec'; // ◀️ **สำคัญ:** ใช้ URL ที่ได้จากการ Deploy ของคุณ
    const form = document.forms['hello-sheet'];
    const sendOtpBtn = document.getElementById('sendOtpBtn');
    const registerBtn = document.getElementById('registerBtn');
    const otpGroup = document.getElementById('otp-group');
    const emailInput = document.getElementById('email');

    // --- 1. เหตุการณ์เมื่อกดปุ่ม "ขอรหัส OTP" ---
    sendOtpBtn.addEventListener('click', e => {
        e.preventDefault();
        
        if (!form.checkValidity()) {
            Swal.fire('ข้อมูลไม่ครบถ้วน', 'กรุณากรอกข้อมูลที่จำเป็นให้ครบถ้วนก่อน', 'warning');
            return;
        }
        
        Swal.fire({
            title: 'กำลังตรวจสอบข้อมูล...',
            text: `ระบบกำลังตรวจสอบรหัสพนักงานและเตรียมส่ง OTP...`,
            allowOutsideClick: false,
            didOpen: () => { Swal.showLoading(); }
        });
        
        const formData = new FormData(form);
        formData.append('action', 'sendOTP');

        fetch(scriptURL, { method: 'POST', body: formData })
            .then(response => response.json())
            .then(data => {
                if (data.result === 'success') {
                    Swal.fire('ส่ง OTP สำเร็จ!', 'กรุณาตรวจสอบรหัสในอีเมลของคุณ (รหัสมีอายุ 5 นาที)', 'success');
                    sendOtpBtn.style.display = 'none';
                    registerBtn.style.display = 'inline-block';
                    otpGroup.style.display = 'block';
                    emailInput.readOnly = true; 
                    document.getElementById('IdEmployee').readOnly = true;
                    document.getElementById('otp').required = true;

                } else if (data.error === 'invalid_employee_id') {
                    Swal.fire('รหัสพนักงานไม่ถูกต้อง', 'ไม่พบรหัสพนักงานของคุณในระบบ กรุณาตรวจสอบอีกครั้ง', 'error');

                } else {
                    throw new Error(data.error || 'ไม่สามารถส่ง OTP ได้');
                }
            })
            .catch(error => {
                console.error('Error sending OTP!', error.message);
                Swal.fire('เกิดข้อผิดพลาด!', 'ไม่สามารถส่ง OTP ได้ กรุณาตรวจสอบข้อมูลและลองใหม่อีกครั้ง', 'error');
            });
    });

    // --- 2. เหตุการณ์เมื่อกดปุ่ม "ลงทะเบียน" (Submit Form) ---
    form.addEventListener('submit', e => {
        e.preventDefault();

        Swal.fire({
            title: 'กำลังตรวจสอบและบันทึกข้อมูล...',
            text: 'กรุณารอสักครู่',
            allowOutsideClick: false,
            didOpen: () => { Swal.showLoading(); }
        });
        
        const formData = new FormData(form);
        formData.append('action', 'register');

        fetch(scriptURL, { method: 'POST', body: formData })
            .then(response => response.json())
            .then(data => {
                if (data.result === 'success') {
                    Swal.fire({
                        position: 'center', icon: 'success', title: 'บันทึกข้อมูลสำเร็จ!',
                        text: 'ข้อมูลของคุณถูกบันทึกในระบบเรียบร้อยแล้ว', showConfirmButton: false, timer: 2500
                    }).then(() => {
                        if(liff.isInClient()) {
                            liff.closeWindow();
                        } else {
                            window.location.reload();
                        }
                    });
                    
                } else if (data.error === 'duplicate') {
                    Swal.fire('ลงทะเบียนแล้ว', 'คุณได้ยืนยันตัวตนไว้ในระบบแล้ว หากต้องการแก้ไขให้ติดต่อที่ฝ่ายบุคคล', 'warning');

                } else if (data.error === 'invalid_otp') {
                    Swal.fire('OTP ไม่ถูกต้อง!', 'รหัส OTP ที่คุณกรอกไม่ถูกต้องหรือหมดอายุแล้ว กรุณาลองใหม่อีกครั้ง', 'error');
                
                } else if (data.error === 'invalid_employee_id') {
                    Swal.fire('รหัสพนักงานไม่ถูกต้อง', 'ไม่พบรหัสพนักงานของคุณในระบบ กรุณาตรวจสอบอีกครั้ง', 'error');

                } else {
                    throw new Error(data.error || 'Something went wrong');
                }
            })
            .catch(error => {
                console.error('Error!', error.message);
                Swal.fire('เกิดข้อผิดพลาด!', 'ไม่สามารถบันทึกข้อมูลได้ กรุณาลองใหม่อีกครั้ง', 'error');
            });
    });
</script>

</body>
</html>
